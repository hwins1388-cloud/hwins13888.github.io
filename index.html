<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Map â†’ Gallery â†’ 360 (Back Buttons)</title>
<link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSans.css" rel="stylesheet">
</head>

<style>
  html, body { margin: 0; height: 100%; overflow: hidden; background: #000; }

  /* ===== 360 ë·°ì–´ ===== */
  #viewerRoot { position: fixed; inset: 0; }

  /* ===== ìƒë‹¨ ë„¤ë¹„(ì§€ë„ë¡œ/ê°¤ëŸ¬ë¦¬ë¡œ) ===== */
  #topNav {
    position: fixed;
    top: 12px; right: 12px;
    z-index: 60;
    display: flex;
    gap: 10px;
  }
  .navBtn {
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font: 700 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    cursor: pointer;
    user-select: none;
    border: 1px solid rgba(255,255,255,0.14);
  }
  .navBtn:hover { filter: brightness(1.05); }
  .navBtn.disabled {
    opacity: 0.45;
    pointer-events: none;
  }

  /* ===== ì§€ë„(ì „ì²´í™”ë©´) ===== */
  #mapOverlay {
    position: fixed; inset: 0;
    z-index: 20;
    display: none;
    background: #000;
  }
  #mapOverlay img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute; inset: 0;
    user-select: none;
    -webkit-user-drag: none;
  }

  /* ===== í•€ ===== */
  .pin {
    position: absolute;
    width: 44px; height: 44px;
    border-radius: 50%;
    background: white;
    color: #111;
    font-weight: 900;
    text-align: center;
    line-height: 44px;
    cursor: pointer;
    transform: translate(-50%, -100%);
    box-shadow: 0 8px 18px rgba(0,0,0,0.45);
    z-index: 5;
    user-select: none;
  }
  .pin:hover { transform: translate(-50%, -100%) scale(1.08); }

  /* ===== ê°¤ëŸ¬ë¦¬(ì¸ë„¤ì¼ ì„ íƒì°½) ===== */
  #galleryOverlay{
    position: fixed;
    inset: 0;
    z-index: 40;
    display: none;
    background-image: url("red_brick.png");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
  }

  #galleryCard{
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: min(980px, 92vw);
    background: rgba(20,20,20,0.92);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 25px 90px rgba(0,0,0,0.55);
  }

  #galleryHeader{
    display:flex;
    align-items:center;
    justify-content: space-between;
    margin-bottom: 12px;
    gap: 12px;
  }
  #placeTitle{
    color:#fff;
    font: 800 16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    letter-spacing: 0.2px;
  }
  #galleryClose{
    color:#fff;
    font: 700 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: rgba(255,255,255,0.14);
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    user-select: none;
  }

  /* ì›í˜• ì¸ë„¤ì¼ */
  #thumbRow{
    padding: 18px 10px 10px;
    justify-content: center;
    align-content: center;
  }

  /* âœ… 1~5ê°œ: í•œ ì¤„ + ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  #thumbRow.mode-row{
    display: flex;
    gap: 36px;
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: center;
    scrollbar-width: thin;
  }
  #thumbRow.mode-row::-webkit-scrollbar{ height: 8px; }
  #thumbRow.mode-row::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,0.18);
    border-radius: 999px;
  }

  /* âœ… 6ê°œ ì´ìƒ: 3ì—´ ê·¸ë¦¬ë“œ */
  #thumbRow.mode-grid{
    display: grid;
    grid-template-columns: repeat(3, 132px);
    gap: 36px;
    justify-content: center;
  }

  .thumb{
    width: 132px; height: 132px;
    border-radius: 999px;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    border: 2px solid rgba(255,255,255,0.08);
    transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    position: relative;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    background-color: #6f778c;
  }
  .thumb:hover{
    transform: translateY(-2px) scale(1.03);
    border-color: rgba(255,255,255,0.35);
    filter: brightness(1.05);
  }
  .thumb .badge{
    position:absolute;
    right: 10px;
    top: 10px;
    width: 28px; height: 28px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font: 900 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: rgba(0,0,0,0.55);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.18);
  }
  #galleryHint{
    margin-top: 10px;
    color: rgba(255,255,255,0.75);
    font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    text-align:center;
  }

  /* ===== ì¸íŠ¸ë¡œ ===== */
  #introOverlay{
    position: fixed;
    inset: 0;
    z-index: 200;
    background: #000;

    /* âœ… ì˜ìƒ(100%)ì„ ì •í™•íˆ ì¤‘ì•™ì •ë ¬ */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #introVideo{
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
  }

  /* âœ… â€œì§€ë„ë¡œ ë“¤ì–´ê°€ê¸°â€ ë²„íŠ¼ (ì²˜ìŒ ìˆ¨ê¹€) */
  #introSkipBtn{
    position: fixed;
    left: 50%;
    bottom: 20%;
    transform: translateX(-50%);
    padding: 12px 18px;
    border-radius: 14px;
    background: rgba(255,255,255,255);
    color: #000;
font-family: "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
font-weight: 800;
font-size: 30px;
line-height: 1;
    border: 3px solid rgba(255,255,255,0.22);
    cursor: pointer;
    user-select: none;
    z-index: 205;
    display: none;
  }
  #introSkipBtn.show{
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
</style>
</head>

<body>

<div id="viewerRoot"></div>

<!-- ===== ì¸íŠ¸ë¡œ ===== -->
<div id="introOverlay">
  <video id="introVideo" autoplay muted playsinline>
    <source src="intro.mp4" type="video/mp4">
  </video>

  <div id="introSkipBtn">ëŒì•„ë³´ê¸°</div>
</div>

<!-- âœ… í•­ìƒ ë³´ì´ëŠ” ë„¤ë¹„ -->
<div id="topNav">
  <div class="navBtn" id="btnToGallery">ê°¤ëŸ¬ë¦¬ë¡œ</div>
  <div class="navBtn" id="btnToMap">ì§€ë„ë¡œ</div>
</div>

<!-- ===== ì§€ë„ ===== -->
<div id="mapOverlay">
  <img src="map.png" alt="map">
  <div class="pin" style="left:6.1%; top:37.7%;" data-place="p1">1</div>
  <div class="pin" style="left:42.8%; top:32%;" data-place="p2">2</div>
  <div class="pin" style="left:60.1%; top:38.1%;" data-place="p3">3</div>
  <div class="pin" style="left:81%; top:77.2%;" data-place="p4">4</div>
  <div class="pin" style="left:75%; top:29.3%;" data-place="p5">5</div>
  <div class="pin" style="left:49.4%; top:60.3%;" data-place="p6">6</div>
  <div class="pin" style="left:78%; top:59%;" data-place="p7">7</div>
</div>

<!-- ===== ê°¤ëŸ¬ë¦¬ ===== -->
<div id="galleryOverlay">
  <div id="galleryCard">
    <div id="galleryHeader">
      <div id="placeTitle">ì´ë¯¸ì§€ ì„ íƒ</div>
      <div id="galleryClose">ë‹«ê¸° âœ•</div>
    </div>
    <div id="thumbRow"></div>
    <div id="galleryHint">ì¸ë„¤ì¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ 360Â° ì´ë¯¸ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
/* =========================
   1) ì¥ì†Œë³„ ì´ë¯¸ì§€ ëª©ë¡
   ========================= */
const PLACES = {
  p1: { name: "ë¹„ì„ë¬¸í™”ë§ˆì„", items: [
    { pano: "p1_1.jpg", thumb: "p1_1.jpg" },
    { pano: "p1_2.jpg", thumb: "p1_2.jpg" },
    { pano: "p1_3.jpg", thumb: "p1_3.jpg" },
    { pano: "p1_4.jpg", thumb: "p1_4.jpg" },
    { pano: "p1_5.jpg", thumb: "p1_5.jpg" },
    { pano: "p1_6.jpg", thumb: "p1_6.jpg" },
  ]},
  p2: { name: "í•œí˜•ì„ììœ ì•„ë™ê·¹ì¥", items: [
    { pano: "p2_1.jpg", thumb: "p2_1.jpg" },
    { pano: "p2_2.jpg", thumb: "p2_2.jpg" },
    { pano: "p2_3.jpg", thumb: "p2_3.jpg" },
    { pano: "p2_4.jpg", thumb: "p2_4.jpg" },
  ]},
  p3: { name: "ëŒ€í†µë ¹ê´€ì €", items: [
    { pano: "p3_1.jpg", thumb: "p3_1.jpg" },
    { pano: "p3_2.jpg", thumb: "p3_2.jpg" },
    { pano: "p3_3.jpg", thumb: "p3_3.jpg" },
    { pano: "p3_4.jpg", thumb: "p3_4.jpg" },
  ]},
  p4: { name: "ë¶€ì‚° ì „ì°¨", items: [
    { pano: "p4_1.jpg", thumb: "p4_1.jpg" },
    { pano: "p4_2.jpg", thumb: "p4_2.jpg" },
    { pano: "p4_3.jpg", thumb: "p4_3.jpg" },
    { pano: "p4_4.jpg", thumb: "p4_4.jpg" },
  ]},
  p5: { name: "ì„ì‹œìˆ˜ë„ì •ë¶€ì²­ì‚¬", items: [
    { pano: "p5_1.jpg", thumb: "p5_1.jpg" },
    { pano: "p5_2.jpg", thumb: "p5_2.jpg" },
    { pano: "p5_3.jpg", thumb: "p5_3.jpg" },
    { pano: "p5_4.jpg", thumb: "p5_4.jpg" },
  ]},
  // p6/p7ì€ ì•„ì§ ë°ì´í„° ì—†ì–´ì„œ ì•ˆë‚´ë§Œ
  p6: { name: "ì¤€ë¹„ì¤‘", items: [] },
  p7: { name: "ì¤€ë¹„ì¤‘", items: [] },
};

/* =========================
   2) ìƒíƒœ
   ========================= */
let lastPlaceKey = null;

const mapOverlay = document.getElementById("mapOverlay");
const galleryOverlay = document.getElementById("galleryOverlay");
const galleryClose = document.getElementById("galleryClose");
const placeTitle = document.getElementById("placeTitle");
const thumbRow = document.getElementById("thumbRow");

const btnToGallery = document.getElementById("btnToGallery");
const btnToMap = document.getElementById("btnToMap");

function setNavState() {
  if (lastPlaceKey) btnToGallery.classList.remove("disabled");
  else btnToGallery.classList.add("disabled");
}

/* =========================
   3) 360 Viewer
   ========================= */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
camera.position.set(0,0,0.1);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
document.getElementById("viewerRoot").appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enablePan = false;
controls.enableZoom = false;
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.rotateSpeed = -0.35;

renderer.domElement.addEventListener("wheel",(e)=>{
  e.preventDefault();
  camera.fov += e.deltaY * 0.05;
  camera.fov = Math.max(30, Math.min(100, camera.fov));
  camera.updateProjectionMatrix();
},{passive:false});

let sphere = null;
let material = null;

function loadPanorama(src){
  const loader = new THREE.TextureLoader();
  loader.load(src, (texture)=>{
    if(!sphere){
      const geo = new THREE.SphereGeometry(500,60,40);
      geo.scale(-1,1,1);
      material = new THREE.MeshBasicMaterial({ map:texture });
      sphere = new THREE.Mesh(geo, material);
      scene.add(sphere);
    } else {
      material.map = texture;
      material.needsUpdate = true;
    }
  }, undefined, (err)=>{
    console.error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", src, err);
    alert("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: " + src + "\níŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€/ì´ë¦„ì´ ì •í™•í•œì§€ í™•ì¸!");
  });
}

// ì‹œì‘ ê¸°ë³¸
loadPanorama(PLACES.p1.items[0].pano);

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* =========================
   4) UI
   ========================= */
function openMap() {
  galleryOverlay.style.display = "none";
  mapOverlay.style.display = "block";
  setNavState();
}

/* ===== ì¸íŠ¸ë¡œ ë¡œì§ ===== */
const introOverlay = document.getElementById("introOverlay");
const introVideo = document.getElementById("introVideo");
const introSkipBtn = document.getElementById("introSkipBtn");

let introLoopTimer = null;
let introBtnTimer = null;

function tryPlayIntro(){
  const p = introVideo.play();
  if (p && typeof p.catch === "function") p.catch(()=>{});
}

function startIntroTimers(){
  // 10ì´ˆë§ˆë‹¤ 0ì´ˆë¡œ ë¦¬ì…‹
  if (introLoopTimer) clearInterval(introLoopTimer);
  introLoopTimer = setInterval(() => {
    try {
      introVideo.currentTime = 0;
      tryPlayIntro();
    } catch (e) {}
  }, 10000);

  // 2ì´ˆ í›„ ë²„íŠ¼ ìë™ í‘œì‹œ
  if (introBtnTimer) clearTimeout(introBtnTimer);
  introBtnTimer = setTimeout(() => {
    introSkipBtn.classList.add("show");
  }, 2000);
}

// ìë™ì¬ìƒ ì‹œë„ + íƒ€ì´ë¨¸ ì‹œì‘
tryPlayIntro();
startIntroTimers();

// í™”ë©´ í´ë¦­ ì‹œ ì¦‰ì‹œ ë²„íŠ¼ í‘œì‹œ + (ìë™ì¬ìƒ ë§‰í˜”ìœ¼ë©´ ì¬ìƒ ì‹œë„)
introOverlay.addEventListener("click", () => {
  introSkipBtn.classList.add("show");
  tryPlayIntro();
}, { passive: true });

// ë²„íŠ¼ í´ë¦­ â†’ ì§€ë„ ì§„ì… + íƒ€ì´ë¨¸ ì •ë¦¬
introSkipBtn.addEventListener("click", (e) => {
  e.stopPropagation();

  if (introLoopTimer) clearInterval(introLoopTimer);
  if (introBtnTimer) clearTimeout(introBtnTimer);

  introOverlay.style.display = "none";
  openMap();
});

/* ===== ê°¤ëŸ¬ë¦¬ ===== */
function openGallery(placeKey) {
  const place = PLACES[placeKey];
  if(!place || !place.items || place.items.length === 0){
    alert("ì´ ì¥ì†ŒëŠ” ì•„ì§ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤ ğŸ™‚");
    return;
  }

  lastPlaceKey = placeKey;

  placeTitle.textContent = place.name + " - ì´ë¯¸ì§€ ì„ íƒ";
  thumbRow.innerHTML = "";

  thumbRow.classList.remove("mode-row", "mode-grid");
  if (place.items.length <= 5) thumbRow.classList.add("mode-row");
  else thumbRow.classList.add("mode-grid");

  place.items.forEach((item, idx)=>{
    const btn = document.createElement("div");
    btn.className = "thumb";
    btn.style.backgroundImage = `url("${item.thumb || item.pano}")`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = (idx + 1);
    btn.appendChild(badge);

    btn.addEventListener("click", ()=>{
      loadPanorama(item.pano);
      galleryOverlay.style.display = "none";
      mapOverlay.style.display = "none";
      setNavState();
    });

    thumbRow.appendChild(btn);
  });

  galleryOverlay.style.display = "block";
  mapOverlay.style.display = "none";
  setNavState();
}

document.querySelectorAll(".pin").forEach(pin=>{
  pin.addEventListener("click", ()=>{
    openGallery(pin.getAttribute("data-place"));
  });
});

galleryClose.addEventListener("click", ()=>{
  galleryOverlay.style.display = "none";
  mapOverlay.style.display = "block";
  setNavState();
});

/* ===== ìƒë‹¨ ë„¤ë¹„ ===== */
btnToMap.addEventListener("click", ()=> openMap());

btnToGallery.addEventListener("click", ()=>{
  if (!lastPlaceKey) return;
  openGallery(lastPlaceKey);
});

/* ESC */
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    if (galleryOverlay.style.display === "block") {
      galleryOverlay.style.display = "none";
      mapOverlay.style.display = "block";
    } else if (mapOverlay.style.display === "block") {
      mapOverlay.style.display = "none";
    }
    setNavState();
  }
});

setNavState();
</script>

</body>
</html>
